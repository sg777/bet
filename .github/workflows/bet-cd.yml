name: bet CD

on:
  push:
    branches: 
        - '**'
  pull_request:
    branches: 
        - '**'
jobs:

  # Build Linux x86 64bit build
  linux-build-x86_64:
    runs-on: ubuntu-22.04

    steps:
    - name: Extract branch name
      shell: bash
      run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
      id: extract_branch

    - name: show extracted branch name
      run: echo ${{ steps.extract_branch.outputs.branch }}

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.extract_branch.outputs.branch }}
    - run: git fetch --prune --unshallow
    
    - name: apt update
      run: sudo apt-get update
      
    - name: Installing dependencies
      run: |
        sudo apt-get install -y autoconf automake build-essential libtool libgmp-dev \
        libsqlite3-dev python3 python3-mako net-tools zlib1g-dev libsodium-dev \
        gettext wget libcurl4-gnutls-dev ninja-build libssl-dev \
        libevent-dev libwebsockets-dev
    
    - name: Build crypto library
      run: make --directory libs/crypto
        
    - name: Build poker application
      run: make --directory poker
      
    - name: Extract git tag
      shell: bash
      run: echo "gittag=$(IFS='-' read -r -a array <<< $(git describe --always) && echo "${array[0]}-${array[1]}")" >> $GITHUB_OUTPUT
      id: extract_git_tag

    - name: Create release archive
      run: |
        pwd && \
        tar -czvf bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz poker/bin/bet poker/bin/cashierd poker/config && \
        ls -lh bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz

    - name: Upload bet-linux-x86_64 release files
      uses: actions/upload-artifact@v4
      with:
        name: bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz
        path: bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz


  # Build Linux ARM 64bit build
  linux-build-arm64:
     runs-on: [self-hosted, linux, ARM64, Raspberry-Pi]
  
     steps:
     - name: Extract branch name
       shell: bash
       run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
       id: extract_branch

     - name: show extracted branch name
       run: echo ${{ steps.extract_branch.outputs.branch }}

     - name: Checkout code
       uses: actions/checkout@v4
       with:
        ref: ${{ steps.extract_branch.outputs.branch }}
     - run: git fetch --prune --unshallow
       
     - name: Build crypto library
       run: make --directory libs/crypto
       
     - name: Build poker application
       run: make --directory poker
       
     - name: Extract git tag
       shell: bash
       run: echo "gittag=$(IFS='-' read -r -a array <<< $(git describe --always) && echo "${array[0]}-${array[1]}")" >> $GITHUB_OUTPUT
       id: extract_git_tag
  
     - name: Create release archive
       run: |
         pwd && \
         tar -czvf bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz poker/bin/bet poker/bin/cashierd poker/config && \
         ls -lh bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz
  
     - name: Cleanup after build
       run: sed -i 's/clean=.*/clean=1/' /home/pi/trigger
       
     - name: Upload bet-linux release files
       uses: actions/upload-artifact@v4
       with:
         name: bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz
         path: bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz



  # Build MacOS 64bit build
  macos-build-x86_64:
    runs-on: macos-latest

    steps:
    - name: Extract branch name
      shell: bash
      run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
      id: extract_branch

    - name: show extracted branch name
      run: echo ${{ steps.extract_branch.outputs.branch }}
      
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.extract_branch.outputs.branch }}
    - run: git fetch --prune --unshallow
    
    - name: Install deps (macOS)
      run: |
          brew update
          brew install zlib
          brew install autoconf
          brew install automake
          brew install libtool
          brew install gmp
          brew install sqlite
          brew install libsodium
          brew install gettext
          brew install wget
          brew install curl
          brew install ninja
          brew install openssl
          brew install libevent
          brew install cmake
          brew install python3
          brew install gnu-sed
          brew install pyenv
          brew install libwebsockets
          pip3 install --break-system-packages mako

    - name: Build crypto library
      run: make --directory libs/crypto
      
    - name: Build poker application
      run: |
          # Detect architecture and set paths accordingly
          if [ "$(uname -m)" = "arm64" ]; then
            BREW_PREFIX="/opt/homebrew"
          else
            BREW_PREFIX="/usr/local"
          fi
          export LDFLAGS="-L${BREW_PREFIX}/opt/openssl/lib -L${BREW_PREFIX}/opt/libwebsockets/lib -L${BREW_PREFIX}/opt/gmp/lib -L${BREW_PREFIX}/opt/sqlite/lib -L${BREW_PREFIX}/opt/libevent/lib"
          export CPPFLAGS="-I${BREW_PREFIX}/opt/openssl/include -I${BREW_PREFIX}/opt/libwebsockets/include -I${BREW_PREFIX}/opt/gmp/include -I${BREW_PREFIX}/opt/sqlite/include -I${BREW_PREFIX}/opt/libevent/include"
          export PKG_CONFIG_PATH="${BREW_PREFIX}/opt/openssl/lib/pkgconfig:${BREW_PREFIX}/opt/libwebsockets/lib/pkgconfig:${BREW_PREFIX}/opt/gmp/lib/pkgconfig:${BREW_PREFIX}/opt/sqlite/lib/pkgconfig:${BREW_PREFIX}/opt/libevent/lib/pkgconfig"
          export OPENSSL_ROOT_DIR=${BREW_PREFIX}/opt/openssl
          make --directory poker
      
    - name: Extract git tag
      shell: bash
      run: echo "gittag=$(array=($(echo $(git describe --always) | tr '-' "\n")) && echo "${array[0]}-${array[1]}")" >> $GITHUB_OUTPUT
      id: extract_git_tag

    - name: Create release archive
      run: |
        pwd && \
        tar -czvf bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz poker/bin/bet poker/bin/cashierd poker/config && \
        ls -lh bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz

    - name: Upload bet-macos-x86_64 release files
      uses: actions/upload-artifact@v4
      with:
        name: bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz
        path: bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz



  publish-release:
      name: Publishing CD releases
      runs-on: ubuntu-latest
      needs: [linux-build-x86_64, macos-build-x86_64, linux-build-arm64]
      
      steps:
        - name: Extract branch name
          shell: bash
          run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
          id: extract_branch

        - name: show extracted branch name
          run: echo ${{ steps.extract_branch.outputs.branch }}

        - name: Checkout code
          uses: actions/checkout@v4
          with:
            ref: ${{ steps.extract_branch.outputs.branch }}
        - run: git fetch --prune --unshallow

        - name: Extract git tag
          shell: bash
          run: echo "gittag=$(IFS='-' read -r -a array <<< $(git describe --always) && echo "${array[0]}-${array[1]}")" >> $GITHUB_OUTPUT
          id: extract_git_tag

        - uses: actions/download-artifact@v4
          with:
            path: artifacts
            
        - name: Display structure of downloaded files
          run: |
            pwd && \
            ls -lhRa
          working-directory: artifacts

        - name: Shortify commit sha
          shell: bash
          run: echo "sha_short=$(echo ${GITHUB_SHA::7})" >> $GITHUB_OUTPUT
          id: shortify_commit

        - name: List Downloaded files
          run: |
            pwd && \
            ls -lh artifacts/bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz/bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz && \
            ls -lh artifacts/bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz/bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz && \
            ls -lh artifacts/bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz/bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz

        - name: Create Release
          id: create_release
          uses: softprops/action-gh-release@v1
          with:
            tag_name: ${{ steps.extract_git_tag.outputs.gittag }}
            name: ${{ steps.extract_git_tag.outputs.gittag }}
            body: |
              CD Release:
              - From Branch: ${{ steps.extract_branch.outputs.branch }}
              - SHA: ${{ steps.shortify_commit.outputs.sha_short }}
              - Version tag: ${{ steps.extract_git_tag.outputs.gittag }}
            draft: false
            prerelease: false
            files: |
              artifacts/bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz/bet-linux-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz
              artifacts/bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz/bet-linux-aarch64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz
              artifacts/bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz/bet-macos-x86_64-${{ steps.extract_git_tag.outputs.gittag }}.tar.gz
